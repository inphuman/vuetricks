---
layout: post
title: Как построить инфраструктуру микрофронтендов на основе Vue
tags: [Vue.js, микро-фронтенды]
comments : False
---

За последние несколько лет многие разработчики, которые боролись с техническими долгами, сталкиваются с 
необходимостью миграций и рефакторинга, а также с существующими паттернами проектирования, которые были хороши для
начальной стадии разработки приложений, но становились сложными и трудными для работы, когда приложения разростались.

Инфраструктура микро-фронтенда поможет вам независимо от того, построено ли ваше приложение на одном фреймворке или если
вы хотите расширять свое приложение с помощью других фреймворков или заменить фреймворк.

## Микрофронтенды с iframe имеют свои минусы

1. **Цикл разработки:** Если у вас нет хорошо написанной инфраструктуры, у вас возникнут некоторые проблемы с такими вещами,
   как запуск локальных окружений, запуск QA-окружения и процесса CI.
2. **Общее состояние:** Управление состоянием при наличии iframe требует определенной инфраструктуры, чтобы знать, нужны ли
   определенные данные между iframe, или между дочерним фреймом и родительским хостом.
3. **Маршрутизация:** Совместное использование маршрутов и разрешений между главным приложением и его дочерними приложениями
   или между дочерними приложениями (является сложной задачей).
4. **Время загрузки:** При неправильном подходе время загрузки iframe может быть довольно медленным, и вероятно, библиотеки
   будут дублироваться во всех iframe.
5. **Доверие:** Выполнение операции от одного фрейма к хосту или другому фрейму требует определенного уровня абстракции, и у
   вас не всегда есть "уверенность" в том, что операция, которую вы хотели выполнить, выполняется или будет выполняться
   в другом контексте.

## Преимущества микрофронтендов с iframe

Да, есть некоторые минусы, но есть и существенные плюсы.

1. Как только ваша инфраструктура завершена, **цикл разработки может быть потрясающим**!
   Работа с разными версиями одного фреймворка/другого фреймворка, управление простым состоянием для
   микро-приложения вместо раздутого гигантского состояния огромного приложения, вы можете иметь динамическое окружение
   и заменять небольшие части приложения без развертывания всего, и тестировать несколько частей из разных версий
   вместе.
2. Когда ваша инфраструктура готова, **маршрутизация не представляет собой никакой проблемы**.
   Вы можете объединять маршруты из разных приложений динамически, и это может отлично работать.
3. Благодаря кэшированию CDN, общим ресурсам и очистке памяти, когда iframe умирает, время загрузки может улучшиться.
4. **Безопасность на первом месте:** Iframe заставляют вас создавать более безопасные приложения, поскольку некоторые данные
   требуют проверки домена, а обмен информацией о пользователе может потребовать их работы в одном домене.
5. **Полная изоляция:** Изоляция iframes позволяет убедиться, что CSS одного приложения не повлияет на другие приложения, а
   также упрощает управление изолированными небольшими областями состояния и файлами перевода (i18n).
6. **Разделенные процессы:** Браузер создает совершенно отдельный процесс для области действия iframe, поэтому вы можете быть уверены, что переполнение внутреннего стека микроприложения не повлияет на поведение хост-приложения и наоборот.

## Недостающая часть инфраструктуры микрофронтендов

Наиболее важной частью платформы, использующей микро-фронтенд решение, является инфраструктура микро-фронтенда.
Написание этой инфраструктуры - непростая задача, но она должна стать общим знанием, которое будет
разделять общие модели поведения решений микро-фронтенда. 

Именно для этого и был создан **microf**.

## Что такое @microf/*?

Это репозиторий, который включает:

[@microf/vue-host](https://github.com/greenpress/microf/blob/main/packages/vue-host/README.md) - плагин для хост-приложения, написанный на Vue 3.

[@microf/vue-child](https://github.com/greenpress/microf/blob/main/packages/vue-child/README.md) - плагин для дочернего приложения, написанного на Vue 3.

### Начальная загрузка хост-приложения:

![Начальная загрузка хост-приложения]({{ site.baseurl }}/assets/img/posts/2022-01-11-vue-based-micro-frontends-infrastructure-1.png)

Плагин запрашивает маршруты всех микроприложений и расширяет маршруты хост-маршрутизатора.

### Хост направляется на внутренний маршрут микроприложения:

![Внутренний маршрут микроприложения]({{ site.baseurl }}/assets/img/posts/2022-01-11-vue-based-micro-frontends-infrastructure-2.png)

### Внутреннее изменение маршрута происходит в дочернем приложении:

![Внутреннее изменение маршрута в дочернем приложении]({{ site.baseurl }}/assets/img/posts/2022-01-11-vue-based-micro-frontends-infrastructure-3.png)

### Хост направляется на существующий маршрут микроприложения:

В этом случае основное приложение направляется в маршрут дочернего приложения, которое уже существует на экране как
часть дочернего приложения. Изменение местоположения iframe приведет к полному обновлению микроприложения, что является не идеальным решением.

Эта проблема решается тем, что плагин внутри хост-приложения посылает сообщение об изменении маршрута плагину внутри
дочернего приложения, который управляет изменением с помощью внутренних методов Vue-Router вместо того, чтобы менять
местоположение самостоятельно.

![Хост направляется на существующий маршрут микроприложения]({{ site.baseurl }}/assets/img/posts/2022-01-11-vue-based-micro-frontends-infrastructure-4.png)

Больше информации по плагинам: [https://github.com/greenpress/microf](https://github.com/greenpress/microf)

Этот проект в настоящее время находится в бета-версии!

Он работает так, как описано, но, возможно, нуждается в некоторых улучшениях.


